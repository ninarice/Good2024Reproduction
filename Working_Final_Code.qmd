---
title: "Working_Final_Code"
format: html
editor: visual
---

## Working_Final_Code

### Loading data and libraries

```{r, message=FALSE}
# Load libraries
library(mice)
library(naniar)
library(tidyverse)
library(broom) 
library(stargazer)
library(caret)

# Load data
repdata <- read.csv("PADD_Agreement Level.csv")

```

### Data Preparation and Cleaning (General)

```{r}

# Add `.id` column for tracking
repdata <- repdata %>% mutate(.id = row_number())

# Visualize missingness (before imputation)
vis_miss(repdata) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 3))

# Define DV and IVs (to exclude from imputation)
exclude_vars <- c("GeWom", "FemSig_P", "FemNeg_P", "FemMed_P", "FemOb_P")

# Create predictor matrix that prevents IVs and DV from being imputed
pred_matrix <- make.predictorMatrix(repdata)
pred_matrix[, exclude_vars] <- 0  # Ensure these columns are NOT imputed

# Perform multiple imputation (pmm, m=5)
set.seed(123)
imputed_data <- mice(repdata, method = "pmm", m = 5, predictorMatrix = pred_matrix)

# Extract long-format data (preserving `.id`)
repdata_long <- complete(imputed_data, "long", include = TRUE)

# Confirm non-imputed variables remain unchanged
summary(repdata_long %>% select(all_of(exclude_vars)))

# Visualize missingness (after imputation)
vis_miss(repdata_long) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 3))

# Create final dataset for analysis
repdata_clean <- repdata_long

```

### Original Paper

#### Running Model seen in Table 4

```{r, warning=FALSE}

# Define models
model1 <- lm(GeWom ~ FemSig_P, data = repdata_clean)  # Women Signatories
model2 <- lm(GeWom ~ FemNeg_P, data = repdata_clean)  # Women Negotiators
model3 <- lm(GeWom ~ FemMed_P, data = repdata_clean)  # Women Mediators
model4 <- lm(GeWom ~ FemOb_P, data = repdata_clean)   # Women Observers

# Generate regression table
stargazer(model1, model2, model3, model4,
          title = "Percentage Measurement of Women Delegates (OLS Regression)",
          dep.var.labels = "Provisions for Women (GeWom)",
          covariate.labels = c("Women Signatories", "Women Negotiators", "Women Mediators", "Women Observers"),
          omit.stat = c("aic", "bic"),
          add.lines = list(
            c("Residual Std. Error", round(c(summary(model1)$sigma, summary(model2)$sigma, summary(model3)$sigma, summary(model4)$sigma), 3)),
            c("F-statistic", round(c(summary(model1)$fstatistic[1], summary(model2)$fstatistic[1], summary(model3)$fstatistic[1], summary(model4)$fstatistic[1]), 3))
          ),
          star.cutoffs = c(0.1, 0.05, 0.01),
          intercept.bottom = TRUE,
          type = "text")

```

#### Original Paper's Main Model: OLS Regression

```{r}

# Run OLS model (pooled across all 5 imputed datasets)
pooled_ols <- with(imputed_data, lm(GeWom ~ FemSig_P + FemNeg_P + FemMed_P + FemOb_P))
pooled_ols_results <- pool(pooled_ols)
summary(pooled_ols_results)

```

##### Visualization
```{r}


```


### Replication

##### Data Preparation for Alternative Models

```{r}

# Convert GeWom to a factor for classification models
repdata_clean$GeWom <- as.factor(repdata_clean$GeWom)

```


#### Alternative Model #1: Logistic Regression

```{r}

# Run logistic regression (pooled across all 5 imputed datasets)
pooled_logit <- with(imputed_data, glm(GeWom ~ FemSig_P + FemNeg_P + FemMed_P + FemOb_P, 
                                       family = binomial))

pooled_logit_results <- pool(pooled_logit)
summary(pooled_logit_results)

```

##### Visualization
```{r}


```


#### Alternative Model #2: Interaction Effects 

(Not significant, likely overfitting)

```{r}

# Run interaction model (pooled across all 5 imputed datasets)
pooled_interaction <- with(imputed_data, glm(GeWom ~ FemSig_P * FemNeg_P + FemMed_P + FemOb_P, 
                                             family = binomial))

pooled_interaction_results <- pool(pooled_interaction)
summary(pooled_interaction_results)
```

##### Visualization
```{r}

```


### Cross-Validation

(Isn't working, we need to decide how to handle missingness)

```{r}

# Define cross-validation settings (10-fold CV)
cv_control <- trainControl(method = "cv", number = 10)

# Train logistic regression model with cross-validation
cv_logit <- train(GeWom ~ FemSig_P + FemNeg_P + FemMed_P + FemOb_P, 
                  data = repdata_clean, 
                  method = "glm", 
                  family = binomial, 
                  trControl = cv_control)

# Print cross-validation results
print(cv_logit)

```

### Evaluating Models

Biggest issue rn: *If* real-world effects exist, we would need a larger dataset or different modeling approach to find *more* evidence to support it.

